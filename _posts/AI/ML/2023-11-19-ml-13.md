---
title: "[ML] GCP ë°°í¬(4) :: Compute Engine & Docker"
excerpt: "[ML] GCP ë°°í¬(4) :: Compute Engine & Docker"
categories: [ML]
tags: [ML, Python]
toc: true
toc_sticky: true
---

Compute Engine & SSHëŠ” G.G,,,,,ã…ã…ã…ã…ã… <br>

FastAPIë¥¼ ì‚¬ìš©í•˜ì—¬ ëª¨ë¸ì„ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” Docker ì´ë¯¸ì§€ë¥¼ ë§Œë“¤ë ¤ë©´ ë‹¤ìŒê³¼ ê°™ì€ ë‹¨ê³„ë¥¼ ë”°ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì•„ë˜ëŠ” ê°„ë‹¨í•œ ì˜ˆì‹œë¥¼ ì œì‹œí•œ ê²ƒì´ë¯€ë¡œ ì‹¤ì œ í”„ë¡œì íŠ¸ì— ë§ê²Œ ìˆ˜ì •í•˜ì…”ì•¼ í•©ë‹ˆë‹¤.

## âœ… 1. FastAPI ì• í”Œë¦¬ì¼€ì´ì…˜ ì‘ì„±:

FastAPIë¥¼ ì‚¬ìš©í•˜ì—¬ ëª¨ë¸ì„ ì œê³µí•˜ëŠ” Python íŒŒì¼ì„ ì‘ì„±í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´, app.pyë¼ëŠ” íŒŒì¼ì— ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```python
Copy code
from fastapi import FastAPI
from fastapi.responses import JSONResponse
import your_model_library # ëª¨ë¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°

app = FastAPI()

@app.post("/predict")
async def predict(data: dict): # ì—¬ê¸°ì—ì„œ ëª¨ë¸ì„ ì‚¬ìš©í•˜ì—¬ ì˜ˆì¸¡ ìˆ˜í–‰
prediction = your_model_library.predict(data)

    return JSONResponse(content={"prediction": prediction})
```

## âœ… 2. Dockerfile ì‘ì„±:

```Dockerfile
Copy code
FROM your_base_image

# í•„ìš”í•œ ì‘ì—… ìˆ˜í–‰

COPY . /app
WORKDIR /app

# FastAPI ë° í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜

RUN pip install fastapi uvicorn

# ì˜ˆì‹œ: Python ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‹¤í–‰

CMD ["uvicorn", "app:app", "--host", "0.0.0.0", "--port", "8000"]
ì—¬ê¸°ì„œ your_base_imageëŠ” ì‚¬ìš©í•˜ëŠ” ë² ì´ìŠ¤ ì´ë¯¸ì§€(ì˜ˆ: python:3.8)ì…ë‹ˆë‹¤.
```

## âœ… 3. Docker ì´ë¯¸ì§€ ë¹Œë“œ:

```bash
docker build -t YOUR_LOCAL_DOCKER_IMAGE .
```

ì—¬ê¸°ì„œ `YOUR_LOCAL_DOCKER_IMAGE` ëŠ” ìƒì„±í•  Docker ì´ë¯¸ì§€ì˜ ì´ë¦„ì…ë‹ˆë‹¤.

## âœ… 4. Docker ì´ë¯¸ì§€ ì €ì¥:

ë‹¤ìŒ ëª…ë ¹ì„ ì‚¬ìš©í•˜ì—¬ ìƒì„±í•œ Docker ì´ë¯¸ì§€ë¥¼ tar ì•„ì¹´ì´ë¸Œë¡œ ì €ì¥í•©ë‹ˆë‹¤.

```bash
docker save -o YOUR_LOCAL_DOCKER_IMAGE.tar.gz YOUR_LOCAL_DOCKER_IMAGE
```

ì—¬ê¸°ì„œ `YOUR_LOCAL_DOCKER_IMAGE.tar.gz` ëŠ” ìƒì„±í•œ Docker ì´ë¯¸ì§€ë¥¼ ì €ì¥í•  tar ì•„ì¹´ì´ë¸Œì˜ ì´ë¦„ì…ë‹ˆë‹¤.

## 5. GCP Compute Engine ì¸ìŠ¤í„´ìŠ¤ë¡œ ë³µì‚¬ ë° ì‹¤í–‰:

ìƒì„±í•œ Docker ì´ë¯¸ì§€ë¥¼ GCP Compute Engine ì¸ìŠ¤í„´ìŠ¤ë¡œ ë³µì‚¬í•˜ê³  ì‹¤í–‰í•©ë‹ˆë‹¤.

```bash
# SDKì—ì„œ ì§„í–‰
gcloud compute scp YOUR_LOCAL_DOCKER_IMAGE.tar.gz INSTANCE_NAME:~
-> gcloud compute scp C:\STUDY\6í•™ê¸°\docker-fast-style-transfer\test-style-transfer.tar.gz instance-practice:~ --zone="asia-east1-b"
gcloud compute ssh INSTANCE_NAME
-> gcloud compute ssh instance-practice --zone="asia-east1-b"

â—ì¼ë‹¨ì€ ì—¬ê¸°ê¹Œì§€ ì§„í–‰ ì•„ë˜ docker loadëŠ” ëª¨ë¥´ê²Ÿë‹¹,,,,,

# ì¸ìŠ¤í„´ìŠ¤ ë‚´ë¶€ì—ì„œ Docker ì´ë¯¸ì§€ ë¡œë“œ ë° ì‹¤í–‰

docker load -i YOUR_LOCAL_DOCKER_IMAGE.tar.gz
docker run -p 8000:8000 YOUR_LOCAL_DOCKER_IMAGE
```

ì—¬ê¸°ì„œ `INSTANCE_NAME` ì€ GCP Compute Engine ì¸ìŠ¤í„´ìŠ¤ì˜ ì´ë¦„ì…ë‹ˆë‹¤.

ì´ì œ FastAPIë¥¼ ì‚¬ìš©í•˜ì—¬ ëª¨ë¸ì„ ì œê³µí•˜ëŠ” Docker ì´ë¯¸ì§€ê°€ GCP Compute Engine ì¸ìŠ¤í„´ìŠ¤ì—ì„œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤. í•´ë‹¹ FastAPI ì• í”Œë¦¬ì¼€ì´ì…˜ì€ /predict ì—”ë“œí¬ì¸íŠ¸ë¥¼ í†µí•´ ëª¨ë¸ì„ í˜¸ì¶œí•˜ê³  ì˜ˆì¸¡ì„ ìˆ˜í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. <br>

ê·¸ëŸ¬ë©´,,, ê·¸ëƒ¥

- cloud functionì—ì„œ storage íŠ¸ë¦¬ê±° ì‚¬ìš©í•´ì„œ compute engine ë¶ˆëŸ¬
- compute engineì—ì„œ docker ì´ë¯¸ì§€ ëŒë¦¬ê¸°
- âœ… ê²°ê³¼ storageë¡œ ì €ì¥ -> â˜‘ï¸ ë³€í™˜ ì´ë¯¸ì§€ ì €ì¥í•  ë²„í‚· ì§€ì • ë° url, ê²½ë¡œ ì§€ì • í•„ìš”

## docker ì´ë¯¸ì§€ ì œì‘ ì „ ìˆ˜ì •í•´ì•¼ë˜ëŠ” ì½”ë“œ ë¶€ë¶„(ì˜¤ëŠ˜ TO DO)

âœ… ê·¸ëƒ¥ CMD `--in-path` ì—ì„œ url ì´ë¯¸ì§€ ì…ë ¥ì„ í•  ìˆ˜ ìˆê²Œë”! <br>
â˜‘ï¸ ê·¸ëƒ¥ CMD `--out-path` ëŠ” ì§€ìš°ê¸° <br>
â˜‘ï¸ json íŒŒì¼ì´ ì—…ë¡œë“œ ëœë‹¤ë©´ cloud functionì—ì„œ style_typeì´ë‘ img_nameì„ compute engineìœ¼ë¡œ ì „ë‹¬ -> compute engine ë°°í¬ í›„ í•´ë³´ê¸° <br>
ğŸ”º main.py ì‘ì„± (ì¼ë‹¨ì€ data ì „ë‹¬ì´ ëœ ìƒíƒœì„ì„ ê°€ì •, wave style typeë§Œ dockerfileë¡œ ë°°í¬í•˜ê¸°ë¡œ..)
